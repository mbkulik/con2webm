#!/usr/bin/env ruby

require 'rubygems'
require 'ffprober'
require 'shellwords'

$num_cpus = 2
$qmin = 10
$qmax = 42
$gval = 120

def convert( video_file )
    
	if video_file =~ /\.mp4|\.m4v/
		mpeg_movie = String.new(video_file)
		webm_movie = String.new(video_file)

		webm_movie[/\.mp4|\.m4v/] = '.webm'

		ffprobe = Ffprober::Parser.from_file(Shellwords.escape(mpeg_movie))

		if File.exists?( webm_movie ) == false
			if ffprobe.video_streams.count == 1
				video_stream = ffprobe.video_streams[0]

				system("ffmpeg -i #{Shellwords.escape(mpeg_movie)} \
					-codec:v libvpx \
					-threads #{$num_cpus} \
					-g #{$gval} \
					-level #{video_stream.level} \
					-qmax #{$qmax} \
					-qmin #{$qmin} \
					-b:v #{video_stream.bit_rate} \
					-codec:a libvorbis \
					#{Shellwords.escape(webm_movie)}")
			end
		end
	end
end

ARGV.each do |arg|
	if File.directory?( arg )
		Dir.foreach(arg) { |d| convert(arg + d) }
	else
		convert( arg )
	end
end
